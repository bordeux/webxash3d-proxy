#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Skip QA checks for merge commits
if [ -f .git/MERGE_HEAD ]; then
  echo "Merge commit detected, skipping QA checks"
  exit 0
fi

# Check if any Rust files are staged for commit
RUST_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(rs)$|^Cargo\.(toml|lock)$' || true)

if [ -z "$RUST_FILES" ]; then
  echo "No Rust files changed, skipping Rust QA checks"
  exit 0
fi

# Run QA checks for commits with Rust changes
echo "Rust files changed, running QA checks..."

echo "Running cargo fmt --check..."
cargo fmt --check
if [ $? -ne 0 ]; then
  echo "❌ Formatting check failed. Run 'cargo fmt' to fix."
  exit 1
fi

echo "Running cargo clippy..."
cargo clippy --all-features --all-targets -- -D warnings
if [ $? -ne 0 ]; then
  echo "❌ Clippy check failed. Fix the warnings above."
  exit 1
fi

echo "✅ All QA checks passed!"
